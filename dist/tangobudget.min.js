/*! tangobudget 2018-09-08 */

function addMarkersAndAll(e,t){path=poly.getPath(),path.push(e);var o=new google.maps.Marker({position:e,label:labels[labelIndex++%labels.length],map:t,draggable:!0,animation:google.maps.Animation.DROP,title:"#"+path.getLength()});markers.push(o),poly.setMap(t),latitud.push(o.getPosition().lat()),longitud.push(o.getPosition().lng()),showCoordenadas(latitud,longitud),google.maps.event.addListener(o,"drag",function(e){if("B"==o.getLabel())path.pop(),path.push(e.latLng),path=poly.getPath(),latitud[1]=o.getPosition().lat(),longitud[1]=o.getPosition().lng();else{var t=path.removeAt(1);path.removeAt(0);path.setAt(1,t),path.setAt(0,e.latLng),path=poly.getPath(),latitud[0]=o.getPosition().lat(),longitud[0]=o.getPosition().lng()}if(flag=2,showCoordenadas(latitud,longitud),2==markers.length){var a=new google.maps.ElevationService;camino[0]=path.getAt(0),camino[1]=path.getAt(1),dist=haversine(radius,latitud,longitud),displayPathElevation(camino,a,dist)}}),o.addListener("click",toggleBounce),2==markers.length&&(elevator||(elevator=new google.maps.ElevationService),camino[0]=path.getAt(0),camino[1]=path.getAt(1),dist=haversine(radius,latitud,longitud),displayPathElevation(camino,elevator,dist))}function Fresnel(e,t,a){var o;o=22/e;var n=haversine(radius,latitud,longitud);tan_alpha=(t-a)/n,alpha=Math.atan(tan_alpha);var l=n/2,d=l/Math.cos(alpha),i=l/Math.cos(alpha),r=altura[cant_redondeo/2];console.log("altura_puntomedio: "+r),R1=Math.sqrt(o*d*i/(d+i));var s=.8*R1,u=.6*R1;return 1<(100*Pmax1-l^2/(s^2+i^2)+(h_Pmax1-r)^2/(2^s))?despeje80:1<(100*Pmax2-l^2/(u^2+i^2)+(h_Pmax2-r)^2/(2^u))?despeje60:sindespeje}function FSL(e,t,a,o){var n;n=22/o;var l=4*Math.PI*e/n;return 20*Math.log10(l)}function InputUser(){var e=document.getElementById("gananciatx").value,t=document.getElementById("gananciarx").value,a=document.getElementById("potenciatx").value,o=document.getElementById("frecuencia").value,n=document.getElementById("disponibilidad").value/100,l=document.getElementById("alturaantenatx").value,d=document.getElementById("alturaantenarx").value,i=haversine(radius,latitud,longitud),r=document.getElementById("perdidasconectores").value,s=document.getElementById("FactorRugosidad").value,u=100*dist,g=(Math.floor(u),FSL(i,l,d,o)),c=MF(i,s,.25,o,n),m=e+t+a-r-g-0,h=Tilt(i,l,d);if(console.log("La frecuencia ingresada es: "+o),console.log("perdidasFSL: "+g),console.log("Prx es: "+m),console.log("El margen de fading es: "+c),console.log("La disponibildad del canal es: "+n),console.log("El valor de A es: "+s),console.log("El angulo del tilt es: "+h),m-MF<m-MF){var v=Fresnel(o,l,d);return v==despeje80?console.log("Existe el despeje del 80%"):v==despeje60?console.log("Existe el despeje del 60%"):console.log("No hay despeje de Fresnel"),0}return alert("No hay sensibilidad del RX suficiente"),2}function LOS(e,t){var a=new google.visualization.DataTable;a.addColumn("string","Muestras"),a.addColumn("number","Elevacion");for(var o=0;o<e.length;o++)a.addRow(["",altura[o]]),"undefined"==a.getValue(o,1)&&(t[o]=0,altura[o]=0);var n,l;new google.visualization.LineChart(document.getElementById("elevation_chart2")).draw(a,{height:200,legend:"none",titleY:"Perfil de elevacion (m)"});var d=altura.indexOf(data.getDistinctValues(1)[e.length-1]);if(0!=d&&d!=e.length-1){console.log("Prueba: "+data.getDistinctValues(1)[e.length-1]);var i=data.getDistinctValues(1)[e.length-1].toFixed(3);return i>altura[e.length-1].toFixed(3)&&i>altura[0].toFixed(3)?0:altura[0].toFixed(3)<i<altura[e.length-1].toFixed(3)?(n=(altura[e.length-1].toFixed(3)-altura[0].toFixed(3))/(e.length-1-0),(i-altura[0].toFixed(3))/(d-0)<=n?1:0):altura[e.length-1].toFixed(3)<i<altura[0].toFixed(3)?(n=(altura[e.length-1].toFixed(3)-altura[0].toFixed(3))/(e.length-1-0))<=(i-altura[0].toFixed(3))/(d-0)?1:0:1}if(0==d||d==e.length-1){if(0==(l=altura.indexOf(data.getDistinctValues(1)[e.length-2]))||l==e.length-1){var r=data.getDistinctValues(1)[e.length-3].toFixed(1),s=altura.indexOf(data.getDistinctValues(1)[e.length-3]);return r>altura[e.length-1].toFixed(3)&&r>altura[0].toFixed(3)?0:altura[0].toFixed(3)<r<altura[e.length-1].toFixed(3)?(n=(altura[e.length-2].toFixed(3)-altura[0].toFixed(3))/(e.length-1-0),(r-altura[0].toFixed(3))/(s-0)<=n?1:0):altura[e.length-1].toFixed(3)<r<altura[0].toFixed(3)?(n=(altura[e.length-1].toFixed(3)-altura[0].toFixed(3))/(e.length-1-0))<=(r-altura[0].toFixed(3))/(s-0)?1:0:1}return 1}var u=data.getDistinctValues(1)[e.length-2].toFixed(1);return u>altura[e.length-1].toFixed(3)&&u>altura[0].toFixed(3)?0:altura[0].toFixed(3)<u<altura[e.length-1].toFixed(3)?(n=(altura[e.length-1].toFixed(3)-altura[0].toFixed(3))/(e.length-1-0),(u-altura[0].toFixed(3))/(l-0)<=n?1:0):altura[e.length-1].toFixed(1)<u<altura[0].toFixed(1)?(n=(altura[e.length-1].toFixed(1)-altura[0].toFixed(1))/(e.length-1-0))<=(u-altura[0].toFixed(1))/(l-0)?1:0:1}function MF(e,t,a,o,n){var l;return l="1"==t?4:"2"==t?1:.25,30*Math.log10(e)+10*Math.log10(6*l*a*o)-10*Math.log10(1-n)-70}function ModifyHeight(){distanciaobject=document.getElementById("distanciaobjeto").value;var e=100*dist;Math.floor(e);if(0<distanciaobject<e){flag=1,muestra_mod[++contador]=Math.floor(distanciaobject/10),console.log("muestra_mod: "+muestra_mod[contador]),displayPathElevation(camino,elevator,dist);var t=LOS(elevations,coordenadas);return console.log("¿Hay LOS2?: "),void(1==t?console.log("Si!"):0==t?console.log("No!"):console.log("Indefinido"))}alert("distancia excede el largo del camino")}function Tilt(e,t,a){return toDegrees(Math.atan((t-a)/e))}function DeshacerAltura(){return 0<=contador?(flag=3,void displayPathElevation(camino,elevator,dist)):void alert("Ya se deshicieron todos los cambios.")}function ClickInput(){geocodeLatLng(new google.maps.Geocoder,map)}function DistanceToBorders(e,t){lat[0]=e[t].lat(),lng[0]=e[t].lng(),lat[1]=e[255].lat(),lng[1]=e[255].lng();var a=haversine(radius,lat,lng);console.log("Distancia a RX"+a.toFixed(6)+" km"),lat[1]=e[0].lat(),lng[1]=e[0].lng();haversine(radius,lat,lng);console.log("Distancia a TX"+a.toFixed(6)+" km")}function dragElement(t){var a=0,o=0,n=0,l=0;function e(e){(e=e||window.event).preventDefault(),n=e.clientX,l=e.clientY,document.onmouseup=i,document.onmousemove=d}function d(e){(e=e||window.event).preventDefault(),a=n-e.clientX,o=l-e.clientY,n=e.clientX,l=e.clientY,t.style.top=t.offsetTop-o+"px",t.style.left=t.offsetLeft-a+"px"}function i(){document.onmouseup=null,document.onmousemove=null}document.getElementById(t.id+"Header")?document.getElementById(t.id+"Header").onmousedown=e:t.onmousedown=e}function displayPathElevation(e,t,a){var o=100*a;cant_redondeo=Math.floor(o),console.log("Cantidad de muestras por km: "+o),console.log("Redondeo de muestras: "+cant_redondeo),t.getElevationAlongPath({path:e,samples:cant_redondeo},plotElevation)}function plotElevation(e,t){var a=document.getElementById("elevation_chart");if("OK"===t){if(!data||2==flag){data=new google.visualization.DataTable,chart=new google.visualization.ColumnChart(a),data.addColumn("string","Sample"),data.addColumn("number","Elevation");for(var o=0;o<e.length;o++)data.addRow(["",e[o].elevation]),"undefined"==data.getValue(o,1)&&(coordenadas[o]=0,altura[o]=0),altura[o]=data.getValue(o,1),coordenadas[o]=e[o].location;flag=0}if(0==flag)h_Pmax1=data.getDistinctValues(1)[e.length-1],h_Pmax2=data.getDistinctValues(1)[e.length-2],Pmax1=altura.indexOf(h_Pmax1),Pmax2=altura.indexOf(h_Pmax2);else if(1==flag){var n=parseFloat(altura[muestra_mod[contador]])+parseFloat(document.getElementById("alturaobjeto").value),l=document.getElementById("distanciaobjeto").value;muestra_mod[contador]=Math.floor(l/10),data.setValue(muestra_mod[contador],1,n),console.log("Muestra moddh: "+muestra_mod[contador]),console.log("alturaobjetodh: "+document.getElementById("alturaobjeto").value),console.log("valuetomodifydh: "+n),document.getElementById("alturaobjeto").value="",document.getElementById("distanciaobjeto").value="",flag=0}else 3==flag&&(data.setValue(muestra_mod[contador],1,altura[muestra_mod[contador]]),flag=0,contador--);chart.draw(data,{height:200,legend:"none",titleX:"Cantidad de muestras",titleY:"Elevation (m)"});var d=LOS(e,coordenadas);console.log("¿Hay LOS?: "),1==d?console.log("Si!"):0==d?console.log("No!"):console.log("Indefinido")}else a.innerHTML="Cannot show elevation: request failed because "+t}function showCoordenadas(e,t){for(var a=0;a<markers.length;a++)document.getElementById("transmisor").value=e[0]+", "+t[0],document.getElementById("receptor").value=e[1]+", "+t[1];if(0!==e[0]&&0!==e[1]){var o=haversine(radius,e,t);document.getElementById("result3").innerHTML=o.toFixed(6)+" km"}}function deleteMarkersAndPath(){markers[0].setMap(null),markers[1].setMap(null),markers=[],latitud=[],longitud=[],camino=[],elevator=[],elevations=[],altura=[],contador=data=0,path=poly.setPath([]),document.getElementById("transmisor").value="",document.getElementById("receptor").value="",document.getElementById("result3").innerHTML="",document.getElementById("elevation_chart").innerHTML="",document.getElementById("elevation_chart2").innerHTML=""}dragElement(document.getElementById("Boton"));var data,chart,distanciaobject,elevator,dist,cant_redondeo,Pmax1,Pmax2,h_Pmax1,h_Pmax2,labels="AB",labelIndex=0,markers=[],latitud=[],longitud=[],radius=6371,camino=[],altura=[],coordenadas=[],posic_puntoMax=0,valor_puntoMax=0,flag=0,muestra_mod=[],contador=0,APP={};function initMap(){var t=new google.maps.Map(document.getElementById("map"),{zoom:15,center:{lat:-34.916467,lng:-56.154272}});google.maps.event.addListener(t,"click",function(e){markers.length<=1&&addMarkersAndAll(e.latLng,t)}),poly=new google.maps.Polyline({strokeColor:"#000000",strokeOpacity:1,strokeWeight:3})}function geocodeLatLng(e,a){console.log("test2");var t=document.getElementById("transmisor").value.split(",",2),o={lat:parseFloat(t[0]),lng:parseFloat(t[1])};e.geocode({location:o},function(e,t){if("OK"===t)if(e[0]){new google.maps.Marker({position:o,map:a});addMarkersAndAll(location,a)}else window.alert("No results found");else window.alert("Geocoder failed due to: "+t)})}function haversine(e,t,a){var o=ToRadians(t[0]),n=ToRadians(a[0]),l=ToRadians(t[1]),d=o-l,i=n-ToRadians(a[1]),r=Math.sin(d/2),s=Math.sin(i/2),u=Math.pow(r,2)+Math.cos(o)*Math.cos(l)*Math.pow(s,2);return 2*e*Math.asin(Math.min(1,Math.sqrt(u)))}function toggleBounce(){marker.setAnimation(google.maps.Animation.BOUNCE)}function printPDF(){var e=new jsPDF("p","pt","letter");e.canvas.height=792,e.canvas.width=612,e.fromHTML(document.body),e.save("test.pdf")}function toDegrees(e){return 180*e/Math.PI}function ToRadians(e){return e*(Math.PI/180)}google.load("visualization","1",{packages:["columnchart"]});