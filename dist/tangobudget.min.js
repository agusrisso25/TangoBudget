/*! tangobudget 2018-12-19 */

function addMarkersAndAll(e,a){path=poly.getPath(),path.push(e);var o=new google.maps.Marker({position:e,label:labels[labelIndex++%labels.length],map:a,draggable:!0,animation:google.maps.Animation.DROP,title:"#"+path.getLength()});markers.push(o),poly.setMap(a),latitud.push(o.getPosition().lat()),longitud.push(o.getPosition().lng()),showCoordenadas(latitud,longitud),google.maps.event.addListener(o,"drag",function(e){if("B"==o.getLabel())path.pop(),path.push(e.latLng),path=poly.getPath(),latitud[1]=o.getPosition().lat(),longitud[1]=o.getPosition().lng();else{var a=path.removeAt(1);path.removeAt(0);path.setAt(1,a),path.setAt(0,e.latLng),path=poly.getPath(),latitud[0]=o.getPosition().lat(),longitud[0]=o.getPosition().lng()}if(flag=2,showCoordenadas(latitud,longitud),2==markers.length){var t=new google.maps.ElevationService;camino[0]=path.getAt(0),camino[1]=path.getAt(1),dist=haversine(radius,latitud,longitud),displayPathElevation(camino,t,dist)}}),o.addListener("click",toggleBounce),2==markers.length&&(elevator||(elevator=new google.maps.ElevationService),camino[0]=path.getAt(0),camino[1]=path.getAt(1),dist=haversine(radius,latitud,longitud),displayPathElevation(camino,elevator,dist))}function Fresnel(e,a,t,o,n){var l;l=22/e;var d=haversine(radius,latitud,longitud);tan_alpha=(a-t)/d,alpha=Math.atan(tan_alpha);var r=d/2,i=altura[cant_redondeo/2];console.log("altura_puntomedio: "+i);var u=r/Math.cos(alpha),s=r/Math.cos(alpha);R1=Math.sqrt(l*u*s/(u+s));var g,c,m=.8*R1,h=.6*R1;return 0==o?(g=100*o-r^2/(a-i+(m^2+s^2)^2/(2^m)),c=100*o-r^2/(a-i+(h^2+s^2)^2/(2^h))):o==d?(g=100*o-r^2/(t-i+(m^2+s^2)^2/(2^m)),c=100*o-r^2/(t-i+(h^2+s^2)^2/(2^h))):(g=100*o-r^2/(n-i+(m^2+s^2)^2/(2^m)),c=100*o-r^2/(n-i+(h^2+s^2)^2/(2^h))),1<g?0:1<c&&g<1?1:2}function FSL(e,a,t,o){var n;n=22/o;var l=4*Math.PI*e/n;return 20*Math.log10(l)}function InputUser(){var e=parseNumber(document.getElementById("gananciatx").value),a=parseNumber(document.getElementById("gananciarx").value),t=parseNumber(document.getElementById("potenciatx").value),o=parseNumber(document.getElementById("frecuencia").value),n=parseNumber(document.getElementById("disponibilidad").value)/100,l=100*dist,d=Math.floor(l),r=parseNumber(document.getElementById("alturaantenatx").value),i=parseNumber(document.getElementById("alturaantenarx").value),u=parseFloat(r)+parseFloat(altura[0]),s=parseFloat(i)+parseFloat(altura[d-1]),g=haversine(radius,latitud,longitud),c=parseNumber(document.getElementById("perdidasconectores").value),m=parseNumber(document.getElementById("otrasperdidas").value),h=document.getElementById("FactorRugosidad").value,v=FSL(g,u,s,o),p=MF(g,h,.25,o,n),f=e+a+t-c-v-m,b=Tilt(g,u,s);if(console.log("La frecuencia ingresada es: "+o),console.log("perdidasFSL: "+v),console.log("Prx es: "+f),console.log("El margen de fading es: "+p),console.log("La disponibildad del canal es: "+n),console.log("El valor de A es: "+h),console.log("El angulo del tilt es: "+b),1==hayLOS)document.getElementById("Ldevista").innerHTML="¡Hay línea de vista!",hayLOS=!0;else{if(0!=hayLOS)return;hayLOS=!1,document.getElementById("Ldevista").innerHTML="¡Cuidado! No hay línea de vista. Se sugiere aumentar las alturas de las antenas."}var y,x,E=Fresnel(o,u,s,Pmax1,h_Pmax1);0==E?(console.log("Existe el despeje del 80%"),x=y=!0):1==E?(console.log("Existe el despeje del 60%"),x=!(y=!1)):(console.log("No hay despeje de Fresnel"),x=y=!1),Resultados(hayLOS,v,p,b,y,x)}var LOS=function(){var m=0;return function(e,a){var t=new google.visualization.DataTable;t.addColumn("string","Muestras"),t.addColumn("number","Elevacion"),t.addRow(["TX",altura[0]]);for(var o=1;o<e.length-1;o++)t.addRow(["",altura[o]]),"undefined"==t.getValue(o,1)&&(a[o]=0,altura[o]=0);t.addRow(["RX",altura[e.length-1]]);var n,l;if(0===m){var d=new google.visualization.ColumnChart(document.getElementById("elevation_chart2")),r=new google.visualization.DataView(t);r.setColumns([0,1,{calc:"stringify",sourceColumn:1,type:"string",role:"annotation"}]),d.draw(r,{height:200,legend:{position:"none"},titleY:"Perfil de elevacion (m)",titleX:"Muestras (m)",color:"yellow"}),m++}var i=altura.indexOf(data.getDistinctValues(1).filter(function(e){return!isNaN(e)})[e.length-1]);if(0!=i&&i!=e.length-1){console.log("Prueba: "+data.getDistinctValues(1)[e.length-1]);var u=data.getDistinctValues(1)[e.length-1].toFixed(3);return u>altura[e.length-1].toFixed(3)&&u>altura[0].toFixed(3)?0:altura[0].toFixed(3)<u<altura[e.length-1].toFixed(3)?(n=(altura[e.length-1].toFixed(3)-altura[0].toFixed(3))/(e.length-1-0),(u-altura[0].toFixed(3))/(i-0)<=n?(console.log("testA2"),1):0):altura[e.length-1].toFixed(3)<u<altura[0].toFixed(3)?(n=(altura[e.length-1].toFixed(3)-altura[0].toFixed(3))/(e.length-1-0),(u-altura[0].toFixed(3))/(i-0)<n?(console.log("testA3"),1):0):(console.log("testA4"),1)}if(0==i||i==e.length-1){if(0==(l=altura.indexOf(data.getDistinctValues(1)[e.length-2]))||l==e.length-1){var s=data.getDistinctValues(1)[e.length-3].toFixed(1),g=altura.indexOf(data.getDistinctValues(1)[e.length-3]);return s>altura[e.length-1].toFixed(3)&&s>altura[0].toFixed(3)?0:altura[0].toFixed(3)<s<altura[e.length-1].toFixed(3)?(n=(altura[e.length-2].toFixed(3)-altura[0].toFixed(3))/(e.length-1-0),(s-altura[0].toFixed(3))/(g-0)<=n?(console.log("testB2"),1):0):altura[e.length-1].toFixed(3)<s<altura[0].toFixed(3)?(n=(altura[e.length-1].toFixed(3)-altura[0].toFixed(3))/(e.length-1-0),(s-altura[0].toFixed(3))/(g-0)<n?(console.log("testB3"),1):0):(console.log("testB4"),1)}var c=data.getDistinctValues(1)[e.length-2].toFixed(1);return c>altura[e.length-1].toFixed(3)&&c>altura[0].toFixed(3)?0:altura[0].toFixed(3)<c<altura[e.length-1].toFixed(3)?(n=(altura[e.length-1].toFixed(3)-altura[0].toFixed(3))/(e.length-1-0),(c-altura[0].toFixed(3))/(l-0)<=n?(console.log("testB22"),1):0):altura[e.length-1].toFixed(1)<c<altura[0].toFixed(1)?(n=(altura[e.length-1].toFixed(1)-altura[0].toFixed(1))/(e.length-1-0),(c-altura[0].toFixed(1))/(l-0)<n?(console.log("testB23"),1):0):(console.log("testB24"),1)}}}();function MF(e,a,t,o,n){var l;return l="1"==a?4:"2"==a?1:.25,30*Math.log10(e)+10*Math.log10(6*l*t*o)-10*Math.log10(1-n)-70}function ModifyHeight(){distanciaobject=parseNumber(document.getElementById("distanciaobjeto").value),distanciatotal=1e3*haversine(radius,latitud,longitud);var e=100*dist,a=Math.floor(e);0==Math.floor(distanciaobject)||Math.floor(distanciaobject)==a-1?alert("No se pueden colocar objetos interferentes en las antenas"):0<distanciaobject&&distanciaobject<distanciatotal&&null!=parseInt(document.getElementById("objetointerferente").value)?(flag=1,muestra_mod[++contador]=Math.floor(distanciaobject/10),displayPathElevation(camino,elevator,dist)):alert("distancia excede el largo del camino")}function ModifyRxTx(){var e=parseNumber(document.getElementById("alturaantenatx").value),a=parseNumber(document.getElementById("alturaantenarx").value);e<=0||a<=0?alert("Altura incorrecta, intente de nuevo"):(flag=4,displayPathElevation(camino,elevator,dist),document.getElementById("alturaantenarx").disabled=!0,document.getElementById("alturaantenatx").disabled=!0)}function Resultados(e,a,t,o,n,l){google.charts.load("current",{packages:["table"]}),google.charts.setOnLoadCallback(function(){data_resultados||((data_resultados=new google.visualization.DataTable).addColumn("boolean","Hay linea de vista?"),data_resultados.addColumn("number","Perdidas de espacio libre (dB)"),data_resultados.addColumn("number","Margen de Fading (dB)"),data_resultados.addColumn("number","Angulo de Tilt"),data_resultados.addColumn("boolean","Despeje 80%?"),data_resultados.addColumn("boolean","Despeje 60%?"),tableRes=new google.visualization.Table(document.getElementById("result_table")));data_resultados.addRow([e,+a,+t,+o,n,l]),tableRes.draw(data_resultados,{showRowNumber:!1,width:"100%",height:"100%"})})}function AgregarTabla(t,o){google.charts.load("current",{packages:["table"]}),google.charts.setOnLoadCallback(function(){data_detabla||((data_detabla=new google.visualization.DataTable).addColumn("string","Tipo"),data_detabla.addColumn("number","Distancia desde el Tx (m)"),data_detabla.addColumn("number","Altura (m)"),data_detabla.addColumn("boolean","Despeje 80%?"),data_detabla.addColumn("boolean","Despeje 60%?"),data_detabla.addColumn("number","Muestra Modificada"),table=new google.visualization.Table(document.getElementById("table_div")));var e,a;a=0==o?e=!0:1==o?!(e=!1):e=!1;data_detabla.addRow([t,+parseFloat(document.getElementById("distanciaobjeto").value),+parseFloat(document.getElementById("alturaobjeto").value),e,a,+muestra_mod[contador]]),table.draw(data_detabla,{showRowNumber:!0,width:"100%",height:"100%"}),document.getElementById("alturaobjeto").value="",document.getElementById("distanciaobjeto").value=""})}function BorrarFila(){data_detabla.removeRow(contador-1),table.draw(data_detabla,{showRowNumber:!0,width:"100%",height:"100%"})}function Tilt(e,a,t){return toDegrees(Math.atan((a-t)/e))}function DeshacerAltura(){return 0<=contador?(flag=3,void displayPathElevation(camino,elevator,dist)):void alert("Ya se deshicieron todos los cambios.")}function DistanceToBorders(e,a){lat[0]=e[a].lat(),lng[0]=e[a].lng(),lat[1]=e[255].lat(),lng[1]=e[255].lng();var t=haversine(radius,lat,lng);console.log("Distancia a RX"+t.toFixed(6)+" km"),lat[1]=e[0].lat(),lng[1]=e[0].lng();haversine(radius,lat,lng);console.log("Distancia a TX"+t.toFixed(6)+" km")}function dragElement(a){var t=0,o=0,n=0,l=0;function e(e){(e=e||window.event).preventDefault(),n=e.clientX,l=e.clientY,document.onmouseup=r,document.onmousemove=d}function d(e){(e=e||window.event).preventDefault(),t=n-e.clientX,o=l-e.clientY,n=e.clientX,l=e.clientY,a.style.top=a.offsetTop-o+"px",a.style.left=a.offsetLeft-t+"px"}function r(){document.onmouseup=null,document.onmousemove=null}document.getElementById(a.id+"Header")?document.getElementById(a.id+"Header").onmousedown=e:a.onmousedown=e}function displayPathElevation(e,a,t){var o=100*t;cant_redondeo=Math.floor(o),console.log("Cantidad de muestras por km: "+o),console.log("Redondeo de muestras: "+cant_redondeo),a.getElevationAlongPath({path:e,samples:cant_redondeo},plotElevation)}function plotElevation(e,a){var t=document.getElementById("elevation_chart");if("OK"===a){if(!data||2==flag){data=new google.visualization.DataTable,chart=new google.visualization.ColumnChart(t),data.addColumn("string","Sample"),data.addColumn("number","Elevation");for(var o=0;o<e.length;o++)data.addRow(["",e[o].elevation]),"undefined"==data.getValue(o,1)&&(coordenadas[o]=NaN,altura[o]=NaN),altura[o]=data.getValue(o,1),coordenadas[o]=e[o].location;flag=0}if(0==flag)h_Pmax1=data.getDistinctValues(1)[e.length-1],h_Pmax2=data.getDistinctValues(1)[e.length-2],Pmax1=altura.indexOf(h_Pmax1),Pmax2=altura.indexOf(h_Pmax2);else if(1==flag){var n=parseFloat(altura[muestra_mod[contador]])+parseFloat(document.getElementById("alturaobjeto").value),l=document.getElementById("distanciaobjeto").value;if(muestra_mod[contador]=Math.floor(l/10),0==muestra_mod[contador]||muestra_mod[contador]==cant_redondeo-1)return void alert("No se pueden colocar objetos interferentes en las antenas, corrija las distancias");if(valuetomodify_array[contador]=parseFloat(document.getElementById("alturaobjeto").value),distanciaobject_array[contador]=parseFloat(document.getElementById("distanciaobjeto").value),data.setValue(muestra_mod[contador],1,n),objInterferente=document.getElementById("objetointerferente").value,!objInterferente)return alert("Ingrese un tipo de interferencia"),void(flag=0);"arbol"==objInterferente?objInterferente="Arbol":"edificio"==objInterferente&&(objInterferente="Edificio"),document.getElementById("frecuencia").value,parseFloat(document.getElementById("alturaantenatx").value),altura[0],parseFloat(document.getElementById("alturaantenarx").value),altura[cant_redondeo-1],distanciaobject_array[contador],resFresnel=valuetomodify_array[contador],AgregarTabla(objInterferente,+resFresnel),flag=0}else 3==flag?(data.setValue(muestra_mod[contador],1,altura[muestra_mod[contador]]),BorrarFila(),contador--,flag=0):4==flag&&(data.setValue(0,1,parseFloat(document.getElementById("alturaantenatx").value)+altura[0]),data.setValue(cant_redondeo-1,1,parseFloat(document.getElementById("alturaantenarx").value)+altura[cant_redondeo-1]),altura[0]=altura[0]+parseFloat(document.getElementById("alturaantenatx").value),altura[cant_redondeo-1]=altura[cant_redondeo-1]+parseFloat(document.getElementById("alturaantenarx").value),flag=0);chart.draw(data,{height:200,legend:"none",titleX:"Cantidad de muestras",titleY:"Elevation (m)"}),1==(hayLOS=LOS(e,coordenadas))?document.getElementById("Ldevista").innerHTML="¡Hay línea de vista!":0==hayLOS&&(document.getElementById("Ldevista").innerHTML="¡Cuidado! No hay línea de vista. Se sugiere aumentar las alturas de las antenas.")}else t.innerHTML="Cannot show elevation: request failed because "+a}function showCoordenadas(e,a){for(var t=0;t<markers.length;t++)document.getElementById("transmisor").value=e[0]+", "+a[0],document.getElementById("receptor").value=e[1]+", "+a[1];if(0!==e[0]&&0!==e[1]){var o=haversine(radius,e,a);document.getElementById("result3").innerHTML=o.toFixed(6)+" km"}}function deleteMarkersAndPath(){markers[0].setMap(null),markers[1].setMap(null),markers=[],latitud=[],longitud=[],camino=[],elevator=[],elevations=[],altura=[],contador=data=0,path=poly.setPath([]),document.getElementById("transmisor").value="",document.getElementById("receptor").value="",document.getElementById("result3").innerHTML="",document.getElementById("Ldevista").innerHTML="",document.getElementById("elevation_chart").innerHTML="",document.getElementById("elevation_chart2").innerHTML=""}dragElement(document.getElementById("Boton"));var data,chart,elevator,dist,cant_redondeo,Pmax1,h_Pmax1,elevations,data_detabla,data_resultados,table,tableRes,hayLOS,resFresnel,labels="TR",labelIndex=0,markers=[],latitud=[],longitud=[],radius=6371,camino=[],altura=[],coordenadas=[],posic_puntoMax=0,valor_puntoMax=0,flag=0,muestra_mod=[],distanciaobject_array=[],contador=0,valuetomodify_array=[],APP={};function initMap(){var a=new google.maps.Map(document.getElementById("map"),{zoom:15,center:{lat:-34.916467,lng:-56.154272}});google.maps.event.addListener(a,"click",function(e){markers.length<=1&&addMarkersAndAll(e.latLng,a)}),poly=new google.maps.Polyline({strokeColor:"#000000",strokeOpacity:1,strokeWeight:3})}function haversine(e,a,t){var o=ToRadians(a[0]),n=ToRadians(t[0]),l=ToRadians(a[1]),d=o-l,r=n-ToRadians(t[1]),i=Math.sin(d/2),u=Math.sin(r/2),s=Math.pow(i,2)+Math.cos(o)*Math.cos(l)*Math.pow(u,2);return 2*e*Math.asin(Math.min(1,Math.sqrt(s)))}function toggleBounce(){marker.setAnimation(google.maps.Animation.BOUNCE)}function printPDF(){var e=new jsPDF;e.fromHTML($("#panel-total").get(0),20,20,{width:500}),e.save("Reporte.pdf")}function toDegrees(e){return 180*e/Math.PI}function parseNumber(e){var a=/^[+-]?(\d+)(?:[,.](\d+))?$/.exec(e);return a?a[2]?+(a[1]+"."+a[2]):+a[1]:NaN}function ToRadians(e){return e*(Math.PI/180)}APP.objInterferente=null,APP.prueba=[],google.load("visualization","1",{packages:["columnchart"]});